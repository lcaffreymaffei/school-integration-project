---
title: "Regression"
author: "Laura Hinton"
date: "5/18/2022"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(haven)
library(broom)
library(fastDummies)
library(stargazer)
library(glmnet)
library(tidymodels)

merged_data_clusters <- read_csv("merged_data_clusters.csv")

```

## Normal Regression with Clusters

```{r select data}
reg_data <- data |> 
  select(lr_all_ols_whg,
         lr_all_ols_wbg,
         lr_all_ols_neg,
         cluster_lab) |> 
  drop_na(cluster_lab)

reg_data <- reg_data |> 
  dummy_cols("cluster_lab", remove_selected_columns = TRUE)

# whg
reg_whg <- lm(lr_all_ols_whg ~ cluster_lab_asian_suburb +
            cluster_lab_low_income_town +
            cluster_lab_rural_white +
            cluster_lab_urban_segregated,
          data = reg_data)

summary(reg_whg)

# wbg
reg_wbg <- lm(lr_all_ols_wbg ~ cluster_lab_asian_suburb +
            cluster_lab_low_income_town +
            cluster_lab_rural_white +
            cluster_lab_urban_segregated,
          data = reg_data)

summary(reg_wbg)

# neg
reg_neg <- lm(lr_all_ols_neg ~ cluster_lab_asian_suburb +
            cluster_lab_low_income_town +
            cluster_lab_rural_white +
            cluster_lab_urban_segregated,
          data = reg_data)

summary(reg_neg)

# tables
varnames = c("Intercept", "Cluster: Asian Suburb", "Cluster: Low-Income Town", "Cluster: Rural White", "Cluster: Urban Segregated")

stargazer(reg_whg, type = "html", out = "whg_regressiontable.html", title = "White-Hispanic Learning Rate Gaps vs. District Characteristics", covariate.labels = varnames, dep.var.caption = "", dep.var.labels = "", intercept.bottom = FALSE, notes.label = "")

stargazer(reg_wbg, type = "html", out = "wbg_regressiontable.html", title = "White-Black Learning Rate Gaps vs. District Characteristics", covariate.labels = varnames, dep.var.caption = "", dep.var.labels = "", intercept.bottom = FALSE, notes.label = "")

stargazer(reg_neg, type = "html", out = "neg_regressiontable.html", title = "ECD-Non-ECD Learning Rate Gaps vs. District Characteristics", covariate.labels = varnames, dep.var.caption = "", dep.var.labels = "", intercept.bottom = FALSE, notes.label = "")

```

## Regularized Regression with Clusters

```{r cluster datasets}
cluster_one <- merged_data_clusters |> 
  filter(cluster == 1)  |> 
  select(cluster, cluster_lab, lr_all_ols_whg, lr_all_ols_wbg,
         lr_all_ols_neg, student_teacher_ratio,
           per_pupil_exp,
           percent_urban,
           percent_suburb,
           percent_town,
           percent_rural,
           percent_city_large,
           percent_city_midsize,
           percent_city_small,
           percent_suburb_large,
           percent_suburb_midsize,
           percent_suburb_small,
           percent_town_fringe,
           percent_town_distant,
           percent_town_remote,
           percent_rural_fringe,
           percent_rural_distant,
           percent_rural_remote,
           percent_native_american,
           percent_asian,
           percent_hispanic,
           percent_black,
           percent_white,
           percent_ecd,
           percent_ell,
           percent_sped,
           total_enrollment,
           diffexpecd_blkwht,
           diffexpecd_hspwht,
           diffexpmin2_blkwht,
           diffexpmin2_hspwht,
           ses_all_bayes,
         pct_stu_iss_black,
         pct_students_ooss_single_black,
         pct_students_ooss_multiple_black,
         pct_expulsions_no_ed_serv_black,
         pct_expulsions_with_ed_black,
         pct_expulsions_no_tol_black,
         pct_students_arrested_black,
         pct_students_ooss_single_hsp,
         pct_students_ooss_multiple_hsp,
         pct_expulsions_no_ed_serv_hsp,
         pct_expulsions_with_ed_hsp,
         pct_expulsions_no_tol_hsp,
         pct_students_arrested_hsp,
         pct_students_ooss_single_white,
         pct_students_ooss_multiple_white,
         pct_expulsions_with_ed_white,
         pct_expulsions_no_tol_white,
         pct_students_arrested_white,
         hsflnfl,
         hsecdnec,
         rswhtblk,
         rswhthsp,
         rsflnfl,
         rsecdnec) |> 
  drop_na()

cluster_two <- merged_data_clusters |> 
  filter(cluster == 2)  |> 
  select(cluster, cluster_lab, lr_all_ols_whg, lr_all_ols_wbg,
         lr_all_ols_neg, student_teacher_ratio,
           per_pupil_exp,
           percent_urban,
           percent_suburb,
           percent_town,
           percent_rural,
           percent_city_large,
           percent_city_midsize,
           percent_city_small,
           percent_suburb_large,
           percent_suburb_midsize,
           percent_suburb_small,
           percent_town_fringe,
           percent_town_distant,
           percent_town_remote,
           percent_rural_fringe,
           percent_rural_distant,
           percent_rural_remote,
           percent_native_american,
           percent_asian,
           percent_hispanic,
           percent_black,
           percent_white,
           percent_ecd,
           percent_ell,
           percent_sped,
           total_enrollment,
           diffexpecd_blkwht,
           diffexpecd_hspwht,
           diffexpmin2_blkwht,
           diffexpmin2_hspwht,
           ses_all_bayes,
         pct_stu_iss_black,
         pct_students_ooss_single_black,
         pct_students_ooss_multiple_black,
         pct_expulsions_no_ed_serv_black,
         pct_expulsions_with_ed_black,
         pct_expulsions_no_tol_black,
         pct_students_arrested_black,
         pct_students_ooss_single_hsp,
         pct_students_ooss_multiple_hsp,
         pct_expulsions_no_ed_serv_hsp,
         pct_expulsions_with_ed_hsp,
         pct_expulsions_no_tol_hsp,
         pct_students_arrested_hsp,
         pct_students_ooss_single_white,
         pct_students_ooss_multiple_white,
         pct_expulsions_with_ed_white,
         pct_expulsions_no_tol_white,
         pct_students_arrested_white,
         hsflnfl,
         hsecdnec,
         rswhtblk,
         rswhthsp,
         rsflnfl,
         rsecdnec) |> 
  drop_na()

cluster_three <- merged_data_clusters |> 
  filter(cluster == 3)  |> 
  select(cluster, cluster_lab, lr_all_ols_whg, lr_all_ols_wbg,
         lr_all_ols_neg, student_teacher_ratio,
           per_pupil_exp,
           percent_urban,
           percent_suburb,
           percent_town,
           percent_rural,
           percent_city_large,
           percent_city_midsize,
           percent_city_small,
           percent_suburb_large,
           percent_suburb_midsize,
           percent_suburb_small,
           percent_town_fringe,
           percent_town_distant,
           percent_town_remote,
           percent_rural_fringe,
           percent_rural_distant,
           percent_rural_remote,
           percent_native_american,
           percent_asian,
           percent_hispanic,
           percent_black,
           percent_white,
           percent_ecd,
           percent_ell,
           percent_sped,
           total_enrollment,
           diffexpecd_blkwht,
           diffexpecd_hspwht,
           diffexpmin2_blkwht,
           diffexpmin2_hspwht,
           ses_all_bayes,
         pct_stu_iss_black,
         pct_students_ooss_single_black,
         pct_students_ooss_multiple_black,
         pct_expulsions_no_ed_serv_black,
         pct_expulsions_with_ed_black,
         pct_expulsions_no_tol_black,
         pct_students_arrested_black,
         pct_students_ooss_single_hsp,
         pct_students_ooss_multiple_hsp,
         pct_expulsions_no_ed_serv_hsp,
         pct_expulsions_with_ed_hsp,
         pct_expulsions_no_tol_hsp,
         pct_students_arrested_hsp,
         pct_students_ooss_single_white,
         pct_students_ooss_multiple_white,
         pct_expulsions_with_ed_white,
         pct_expulsions_no_tol_white,
         pct_students_arrested_white,
         hsflnfl,
         hsecdnec,
         rswhtblk,
         rswhthsp,
         rsflnfl,
         rsecdnec) |> 
  drop_na()

cluster_four <- merged_data_clusters |> 
  filter(cluster == 4)  |> 
  select(cluster, cluster_lab, lr_all_ols_whg, lr_all_ols_wbg,
         lr_all_ols_neg, student_teacher_ratio,
           per_pupil_exp,
           percent_urban,
           percent_suburb,
           percent_town,
           percent_rural,
           percent_city_large,
           percent_city_midsize,
           percent_city_small,
           percent_suburb_large,
           percent_suburb_midsize,
           percent_suburb_small,
           percent_town_fringe,
           percent_town_distant,
           percent_town_remote,
           percent_rural_fringe,
           percent_rural_distant,
           percent_rural_remote,
           percent_native_american,
           percent_asian,
           percent_hispanic,
           percent_black,
           percent_white,
           percent_ecd,
           percent_ell,
           percent_sped,
           total_enrollment,
           diffexpecd_blkwht,
           diffexpecd_hspwht,
           diffexpmin2_blkwht,
           diffexpmin2_hspwht,
           ses_all_bayes,
         pct_stu_iss_black,
         pct_students_ooss_single_black,
         pct_students_ooss_multiple_black,
         pct_expulsions_no_ed_serv_black,
         pct_expulsions_with_ed_black,
         pct_expulsions_no_tol_black,
         pct_students_arrested_black,
         pct_students_ooss_single_hsp,
         pct_students_ooss_multiple_hsp,
         pct_expulsions_no_ed_serv_hsp,
         pct_expulsions_with_ed_hsp,
         pct_expulsions_no_tol_hsp,
         pct_students_arrested_hsp,
         pct_students_ooss_single_white,
         pct_students_ooss_multiple_white,
         pct_expulsions_with_ed_white,
         pct_expulsions_no_tol_white,
         pct_students_arrested_white,
         hsflnfl,
         hsecdnec,
         rswhtblk,
         rswhthsp,
         rsflnfl,
         rsecdnec) |> 
  drop_na()
```

## Regularized Regression with Clusters

```{r cluster one}

# outcomes: lr_all_ols_whg, lr_all_ols_wbg, lr_all_ols_neg

# split data
set.seed(1234)

cluster_one_split <- 
  initial_split(cluster_one, 
                prop = .8,
                strata = lr_all_ols_whg)

cluster_one_train <- training(cluster_one_split)

cluster_one_test <- testing(cluster_one_split)

cluster_one_recipe <- 
  recipe(lr_all_ols_whg ~ ., 
         data = cluster_one_train) |> 
  step_rm(lr_all_ols_wbg, lr_all_ols_neg, cluster_lab, cluster)

cluster_one_recipe |> 
  prep(training = cluster_one_train) |> 
  bake(new_data = NULL) |> 
  glimpse()

ridge_spec <- 
  linear_reg(penalty = 1, mixture = 0) |>
  set_engine("glmnet") |>
  set_mode("regression")

ridge_wf <- 
  workflow() |> 
  add_model(ridge_spec) |> 
  add_recipe(cluster_one_recipe)

ridge_wf

ridge_fit <- 
  fit(ridge_wf, 
      data = cluster_one_train)

tidy(ridge_fit)

tidy(ridge_fit) |> 
  arrange(abs(estimate)) |> 
  filter(term != "(Intercept)") |> 
  slice_tail(n = 10) |> 
  ggplot(aes(x = reorder(term, estimate),
             y = estimate,
             fill = estimate > 0)) +
  geom_col() +
  coord_flip()

regularization_spec <- 
  linear_reg(penalty = tune(), mixture = tune()) |>
  set_engine("glmnet") |> 
  set_mode("regression")

grid <- 
  expand_grid(penalty = seq(0, 0.1, by = 0.005), # these values are used often
              mixture = seq(0, 1, by = 0.2))

cluster_one_cv <- 
  vfold_cv(cluster_one_train, v = 5)

cluster_one_results <- 
  tune_grid(regularization_spec,
            preprocessor = cluster_one_recipe,
            grid = grid,
            resamples = cluster_one_cv)

cluster_one_results |> 
  collect_metrics()  |> 
  filter(.metric == "rmse") |>
  ggplot(aes(x = penalty, y = mean, color = as.factor(mixture))) + 
  geom_point() + 
  geom_line() + 
  ylab("RMSE")

cluster_one_best_model <- 
  cluster_one_results |>   
  select_best(metric = "rmse")

cluster_one_best_model

cluster_one_final_spec <- 
  linear_reg(penalty = 0.01, mixture = 0.6) |> 
  set_engine("glmnet") |> 
  set_mode("regression")

cluster_one_final_wf <- 
  workflow()  |> 
  add_model(cluster_one_final_spec)  |> 
  add_recipe(cluster_one_recipe)

cluster_one_final_wf

cluster_one_final_fit <- 
  cluster_one_final_wf |>  
  fit(data = cluster_one_train)

all_cluster_one_variables <- tidy(cluster_one_final_fit)
# kicked out everything?

tidy(cluster_one_final_fit) |> 
  arrange(abs(estimate))|> 
  slice_tail(n = 10) |> 
  ggplot(aes(x = term,
             y = estimate)) +
  geom_col() +
  coord_flip()
```

